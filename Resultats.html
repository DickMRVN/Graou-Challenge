<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="results_page_title">Graou Challenge | R√©sultats</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #4CAF50; 
            --secondary-color: #333;
            --light-bg: #f4f7f9;
            --dark-bg: #1e1e2f;
            --text-light: #ffffff;
            /* COULEURS SUPPL√âMENTAIRES */
            --rafiki-color: #FF6347; /* Tomato */
            --player-sp-color: #007bff; /* Bleu pour les points SP */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
            color: var(--secondary-color);
            background-color: var(--light-bg);
            scroll-behavior: smooth;
            padding-top: 80px;
        }

        a {
            text-decoration: none;
            color: var(--primary-color);
        }

        .cta-button {
            display: inline-block;
            padding: 12px 30px;
            margin-top: 20px;
            background-color: var(--primary-color);
            color: var(--text-light);
            font-weight: 600;
            border-radius: 50px;
            transition: background-color 0.3s, transform 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }

        .cta-button:hover {
            background-color: #43a047;
            transform: translateY(-2px);
        }

        /* =======================================================
        HEADER & NAVIGATION
        ======================================================= */
        header {
            position: fixed;
            width: 100%;
            top: 0;
            display: flex;
            justify-content: space-between; 
            align-items: center;
            padding: 15px 5%;
            background-color: var(--text-light);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            z-index: 1000;
        }
        
        #language-selector {
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9em;
            cursor: pointer;
            background-color: var(--text-light);
            color: var(--secondary-color);
            margin-left: 25px; 
        }

        .logo {
            font-size: 1.8em;
            font-weight: 700;
            color: var(--secondary-color);
        }
        
        nav {
            display: flex; 
            align-items: center;
        }
        
        nav a {
            margin-left: 25px;
            font-weight: 600;
            color: var(--secondary-color);
            transition: color 0.3s;
        }

        nav a:hover {
            color: var(--primary-color);
        }
        
        nav .cta-button {
            margin-top: 0; 
        }

        /* =======================================================
        RESULTS SPECIFIC STYLES
        ======================================================= */
        .results-section {
            padding: 60px 5%;
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
            min-height: calc(100vh - 80px - 140px);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .results-section h1 {
            font-size: 3em;
            font-weight: 700;
            margin-bottom: 30px;
            color: var(--secondary-color);
        }
        
        /* --- STYLES DES ONGLETS --- */
        .tab-nav {
            margin: 30px auto;
            display: flex;
            justify-content: center;
            border-bottom: 2px solid #e0e0e0;
            width: 90%;
            max-width: 800px;
        }

        .tab-button {
            background-color: transparent;
            border: none;
            padding: 15px 25px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            color: #666;
            transition: color 0.3s, border-bottom 0.3s;
            border-bottom: 3px solid transparent;
            margin: 0 5px;
            white-space: nowrap;
        }

        .tab-button:hover {
            color: #555;
        }

        .tab-button.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }

        /* --- STYLES DU CONTENU D'ONGLET --- */
        .tab-content {
            display: none;
            width: 100%;
            max-width: 1200px; 
            padding: 30px 0;
            animation: fadeIn 0.5s;
        }

        .tab-content.active-content {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Style pour l'affichage "EN COURS" / Erreurs */
        .info-block {
            padding: 40px;
            background-color: var(--text-light);
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            max-width: 800px; 
            width: 90%;
            margin: 30px auto;
            text-align: center;
        }
        
        .info-block h2 {
            font-size: 2.0em;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .error-details {
            font-family: monospace;
            background-color: #fcecec;
            color: #cc0000;
            padding: 15px;
            border: 1px solid #f0a3a3;
            border-radius: 5px;
            margin-top: 15px;
            white-space: pre-wrap;
            text-align: left;
            font-size: 0.9em;
        }

        /* --- CONTR√îLES D'√âPISODE --- */
        #episode-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 1200px;
            margin-bottom: 20px;
            text-align: left;
        }
        
        #episode-selector-container label {
            font-weight: 600;
            margin-right: 10px;
        }
        
        #episode-selector-container select {
            padding: 8px 15px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 1em;
        }

        /* =======================================================
        AJOUT NOUVEAU : STYLES DU TABLEAU DE DONN√âES 
        ======================================================= */
        .tab-content table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            text-align: left;
        }

        .tab-content th, .tab-content td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
            vertical-align: top; 
        }

        /* Centrage pour la colonne Rank et Points */
        .tab-content td:first-child { 
            text-align: center;
            font-weight: 700;
        }
        
        .points-cell {
            text-align: center;
            font-weight: 700;
            font-size: 1.1em;
        }
        
        .rafiki-points {
            color: var(--rafiki-color); 
            font-size: 1.1em;
            font-weight: 700; 
        }

        .team-name-cell {
            display: flex;
            align-items: center;
            font-weight: 600;
        }
        
        .detail-button {
            padding: 5px 10px;
            background-color: var(--primary-color);
            color: var(--text-light);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background-color 0.2s;
        }

        .tab-content th {
            background-color: var(--primary-color);
            color: var(--text-light);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .tab-content tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .tab-content tr:hover {
            background-color: #f0f0f0;
        }
        
        /* Style pour l'affichage des joueurs (Liste compacte) */
        .player-sp-list {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 0.9em;
            color: var(--secondary-color);
        }
        
        .player-sp-list li {
            padding: 2px 0;
            border-bottom: 1px dotted #eee;
        }
        
        /* MODIFICATION: Style pour l'affichage des points dans le nouveau format */
        .player-sp-list li .player-score {
            font-weight: 600;
            color: var(--player-sp-color);
            margin-left: 5px;
        }
        
        .team-members-list {
            margin-top: 5px;
            padding: 5px 0 0 10px;
            font-size: 0.9em;
            color: #555;
            text-align: left;
            border-top: 1px dashed #ddd;
        }
        
        .team-members-list ul {
            list-style: disc;
            padding-left: 20px;
            margin-top: 5px;
        }
        
        /* --- NOUVEAUX STYLES DU LEADERBOARD PODIUM (TOP 3) --- */
        #season-podium-container {
            margin: 80px auto 50px auto; 
            width: 100%;
            max-width: 1000px; /* Augmentation de la taille max du conteneur */
            display: flex;
            justify-content: center;
            align-items: flex-end; 
            min-height: 400px; 
            position: relative;
        }

        /* Base pour le contenu de l'√©quipe (logo, nom, points) */
        .podium-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 10;
            margin: 0; 
            width: auto; 
            /* Permet le retour √† la ligne du nom d'√©quipe si n√©cessaire */
        }

        .podium-team-image {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            margin-bottom: 10px;
            background-color: #f0f0f0;
        }

        .podium-team-name {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 5px;
            text-align: center;
            line-height: 1.2;
            /* Retire le white-space: nowrap pour permettre le retour √† la ligne */
            max-width: 160px; /* Limite la largeur du nom pour forcer le wrap si besoin */
        }

        .podium-points {
            font-size: 1.0em;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .podium-rank-label {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--secondary-color);
            margin-bottom: 5px;
        }

        /* ---------------------------------------------------- */
        /* ALIGNEMENT ET TAILLE SPECIFIQUE AU TOP 3 */
        /* ---------------------------------------------------- */

        /* 1st Place Specific Item (Positionnement au centre) */
        .podium-item.first {
            position: absolute;
            z-index: 30; 
            /* Positionnement bas√© sur la hauteur de la marche 1 (200px) + un petit d√©calage */
            bottom: calc(200px + 15px); 
            left: 50%;
            transform: translateX(-50%); /* CENTRAGE HORIZONTAL PARFAIT */
        }

        /* 1. Logo du 1er plus grand */
        .podium-item.first .podium-team-image {
            width: 140px; /* Logo agrandi */
            height: 140px;
            border: 5px solid #FFD700; /* Gold */
        }

        .podium-item.first .podium-team-name {
            font-size: 1.4em;
            color: var(--secondary-color);
        }

        .podium-item.first .podium-points {
            font-size: 1.2em;
            color: #FFD700;
        }
        
        /* 2nd Place Item (Positionnement align√©) */
        .podium-item.second {
            position: absolute;
            z-index: 20;
            /* Positionnement bas√© sur la hauteur de la marche 2 (150px) */
            bottom: calc(150px + 15px); 
            /* Calcul pour centrer au-dessus de la marche 2: 50% - (180px large + 25px gap) = 50% - 205px */
            left: calc(50% - 205px); 
            transform: translateX(-50%); /* CENTRAGE HORIZONTAL PARFAIT */
        }

        /* 3rd Place Item (Positionnement align√©) */
        .podium-item.third {
            position: absolute;
            z-index: 20;
            /* Positionnement bas√© sur la hauteur de la marche 3 (100px) */
            bottom: calc(100px + 15px); 
            /* Calcul pour centrer au-dessus de la marche 3: 50% - (180px large + 25px gap) = 50% - 205px */
            right: calc(50% - 205px); 
            transform: translateX(50%); /* CENTRAGE HORIZONTAL PARFAIT */
        }


        /* ---------------------------------------------------- */
        /* STRUCTURE DES MARCHES (Les blocs color√©s) */
        /* ---------------------------------------------------- */

        .podium-steps-structure {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 250px; 
        }

        .podium-step {
            width: 180px; /* MARCHE PLUS LARGE */
            color: white;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            border-radius: 5px 5px 0 0;
            margin: 0 12.5px; /* Pour cr√©er un espace total de 25px entre les marches */
            padding: 10px 0;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            position: relative;
            min-height: 100px;
        }

        .rank-number {
            font-size: 2.5em;
            font-weight: 700;
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(0, 0, 0, 0.1); 
            z-index: 1;
        }

        /* 2nd Place Step */
        .podium-step.second {
            height: 150px;
            background-color: #c0c0c0; /* Silver */
            order: 1; /* Left side */
        }

        /* 1st Place Step */
        .podium-step.first-step {
            height: 200px;
            background-color: #FFD700; /* Gold */
            order: 2; /* Center */
            margin: 0 12.5px; 
            position: relative;
        }

        /* 3rd Place Step */
        .podium-step.third {
            height: 100px;
            background-color: #cd7f32; /* Bronze */
            order: 3; /* Right side */
        }

        /* =======================================================
        FOOTER
        ======================================================= */
        footer {
            background-color: var(--dark-bg);
            color: var(--light-bg);
            text-align: center;
            padding: 30px 5%;
            font-size: 0.9em;
            margin-top: auto; 
        }

        .social-links a {
            color: var(--light-bg); 
            margin: 0 10px;
            font-size: 1.5em;
            display: inline-flex;
            align-items: center;
            transition: color 0.3s ease; 
        }

        .social-links a i {
            margin-right: 5px; 
        }

        .social-links a:hover {
            color: var(--primary-color); 
        }
    </style>
</head>
<body>

    <header>
        <div class="logo" data-i18n="logo">Graou Challenge</div>
        <nav>
            <a href="index.html" data-i18n="nav_home">Accueil</a>
            <a href="index.html#about" data-i18n="nav_about">L'√©v√©nement</a>
            <a href="#" data-i18n="nav_results">R√©sultats</a>
            <a href="Reglement.html" data-i18n="nav_rules">R√®glement</a>
            
            <select id="language-selector" onchange="changeLanguage(this.value)">
                <option value="fr">Fran√ßais</option>
                <option value="en">English</option>
                <option value="de">Deutsch</option>
            </select>
            
            <a href="Inscription.html" class="cta-button" data-i18n="nav_register">Inscription</a>
        </nav>
    </header>

    <main class="results-section">
        <h1 data-i18n="results_main_title_dynamic">Tableau de bord des R√©sultats</h1>
        
        <div class="tab-nav">
            <button class="tab-button active" data-tab="teams" data-i18n="tab_teams" onclick="switchTab('teams')">Liste des √âquipes</button>
            <button class="tab-button" data-tab="episode" data-i18n="tab_episode" onclick="switchTab('episode')">Leaderboard √âpisode</button>
            <button class="tab-button" data-tab="season" data-i18n="tab_season" onclick="switchTab('season')">Classement Saison</button>           
        </div>

        <div id="content-season" class="tab-content">
            </div>

        <div id="content-episode" class="tab-content">
            <div id="episode-controls">
                <p style="font-size: 1.1em; font-weight: 600;">
                    <span data-i18n="episode_leaderboard_title_label">R√©sultats √âpisode</span>
                    <strong id="current-episode-display">...</strong> / <span data-i18n="season_text">Saison</span> <strong id="current-season-display">...</strong>
                </p>
                <div id="episode-selector-container">
                    </div>
            </div>

            <div id="episode-content-wrapper">
                <p style="padding: 50px;"><i class="fa-solid fa-spinner fa-spin-pulse fa-2x"></i> <span data-i18n="loading_data">Chargement des donn√©es...</span></p>
            </div>
        </div>

        <div id="content-teams" class="tab-content active-content">
            </div>

    </main>

    <footer>
        <div class="social-links">
            <a href="https://www.twitch.tv/lionvibs" target="_blank" rel="noopener noreferrer" aria-label="Twitch">
                <i class="fa-brands fa-twitch"></i> <span data-i18n="footer_twitch_text">Twitch</span>
            </a>
            <a href="https://discord.gg/zGpmm5qJ" target="_blank" rel="noopener noreferrer" aria-label="Discord">
                <i class="fa-brands fa-discord"></i> <span data-i18n="footer_discord_text">Discord</span>
            </a>
            <a href="https://www.youtube.com/@LionViBS07" target="_blank" rel="noopener noreferrer" aria-label="YouTube">
                <i class="fa-brands fa-youtube"></i> <span data-i18n="footer_youtube_text">YouTube</span>
            </a>
            <a href="https://www.tiktok.com/@lionvibs" target="_blank" rel="noopener noreferrer" aria-label="TikTok">
                <i class="fa-brands fa-tiktok"></i> <span data-i18n="footer_tiktok_text">TikTok</span>
            </a>
            <a href="https://www.instagram.com/lionvibs/" target="_blank" rel="noopener noreferrer" aria-label="Instagram">
                <i class="fa-brands fa-instagram"></i> <span data-i18n="footer_instagram_text">Instagram</span>
            </a>
            <a href="https://streamelements.com/lionvibs/tip" target="_blank" rel="noopener noreferrer" aria-label="Donation">
                <i class="fa-solid fa-hand-holding-dollar"></i> <span data-i18n="footer_donation_text">Donation</span>
            </a>
        </div>
        <p data-i18n="footer_rights">&copy; 2025 Graou Challenge. Tous droits r√©serv√©s.</p>
    </footer>

    <script>
        // ========================================================
        // üöÄ CONFIGURATION SUPABASE 
        // ========================================================
        
        const SUPABASE_URL = 'https://nojncodjakemrinwpjhz.supabase.co'; ¬† ¬†
        const SUPABASE_ANON_KEY = 'sb_publishable_-6UkrAaWlOQajthXJvwXlQ_xbS1f_nQ'; 
        const TEAM_TABLE = 'teams'; 
        const EPISODE_LEADERBOARD_VIEW = 'episode_leaderboard';
        const SEASON_LEADERBOARD_VIEW = 'season_leaderboard'; 
        const PLAYER_EPISODE_LEADERBOARD_VIEW = 'player_episode_leaderboard';
        const MEMBERS_TABLE = 'team_memberships'; 

        const EPISODE_CONFIG_TABLE = 'episode_config';
        const TEAM_BONUS_TABLE = 'team_episode_bonus'; 
        
        const RAFIKI_POINTS_COLUMN = 'points_rafiki'; 
        
        const TEAM_POINTS_COLUMN = 'total_team_points'; 
        const PLAYER_CONTRIBUTION_COLUMN = 'total_team_contribution_points';


        // Variables dynamiques
        let CURRENT_SEASON = null; 
        let CURRENT_EPISODE = 1; 
        let AVAILABLE_EPISODES = []; 
        let currentLang = 'fr'; 

        // ========================================================
        // FONCTIONS UTILITAIRES G√âN√âRALES
        // ========================================================

        /**
         * D√©termine si la couleur d'√©quipe est trop claire et retourne noir si c'est le cas.
         */
        function getReadableTextColor(hexcolor) {
            const hex = hexcolor.startsWith('#') ? hexcolor.slice(1) : hexcolor;
            if (hex.length !== 6) return hexcolor; 
            
            const r = parseInt(hex.substring(0, 2), 16);
            const g = parseInt(hex.substring(2, 4), 16);
            const b = parseInt(hex.substring(4, 6), 16);
            
            // Calcul de la luminance (seuil 200)
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b);
            
            if (luminance > 200) { 
                return '#000000'; // Noir
            } else {
                return '#' + hex; // Couleur d'√©quipe
            }
        }
        
        /**
         * R√©cup√®re la langue initiale √† partir de l'attribut lang du HTML.
         */
        function getInitialLanguage() {
            return document.documentElement.lang || 'fr';
        }
        
        /**
         * R√©cup√®re les donn√©es de base de toutes les √©quipes (couleur, logo).
         */
        async function fetchAllTeamData() {
            // FIX: Utilisation de logo_path au lieu de logo_url
            const teamsUrl = `${SUPABASE_URL}/rest/v1/${TEAM_TABLE}?select=id,name,couleur,logo_path`;
            const teamsResponse = await fetch(teamsUrl, { 
                method: 'GET', 
                headers: { 'apikey': SUPABASE_ANON_KEY, 'Content-Type': 'application/json' } 
            });
            if (!teamsResponse.ok) {
                throw new Error(`√âchec R√âCUP√âRATION COULEURS/LOGOS √âQUIPE (${teamsResponse.status}): ${await teamsResponse.text()}`);
            }
            const teamsList = await teamsResponse.json();
            
            const teamDataMap = {};
            teamsList.forEach(t => {
                teamDataMap[t.name] = {
                    couleur: t.couleur || '#333',
                    // FIX: Utilisation de logo_path dans le map
                    logo_path: t.logo_path || '',
                    id: t.id
                };
            });
            return teamDataMap;
        }


        // ========================================================
        // FONCTION UTILITAIRE POUR LE DIAGNOSTIC D'ERREUR
        // ========================================================

        function renderError(wrapper, source, error, lang, isEnCours=false) {
            if (isEnCours) {
                wrapper.innerHTML = `<div class="info-block"><h2>${translations[lang].episode_in_progress}</h2><p>${translations[lang].episode_in_progress_detail}</p></div>`;
            } else {
                const html = `
                    <div class="info-block" style="background-color: #ffebeb; border: 1px solid red;">
                        <h2 style="color: red;">${translations[lang].error_title}</h2>
                        <p style="margin-bottom: 5px;">
                            ${translations[lang].error_text}
                        </p>
                        <div class="error-details">
                            <strong>Source de l'√©chec :</strong> ${source}<br>
                            <strong>D√©tails :</strong> ${error.message}<br><br>
                            
                            <p style="font-weight: bold; color: #cc0000;">
                                Si cette erreur persiste, v√©rifiez la casse de votre nom de vue/colonne (ex: total_team_points) directement dans Supabase.
                            </p>
                        </div>
                    </div>
                `;
                wrapper.innerHTML = html;
            }
            changeLanguage(lang); 
        }
        
        // ========================================================
        // 1. LOGIQUE DE L'ONGLET 'LEADERBOARD √âPISODE'
        // ========================================================
        
        async function fetchCurrentSeason() {
            const apiUrl = `${SUPABASE_URL}/rest/v1/${EPISODE_CONFIG_TABLE}?select=season&order=season.desc&limit=1`;
            try {
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: { 'apikey': SUPABASE_ANON_KEY, 'Content-Type': 'application/json' }
                });
                if (!response.ok) {
                    throw new Error(`√âchec R√âCUP√âRATION SAISON (${response.status}): ${response.statusText}`);
                }
                const data = await response.json();
                if (data.length > 0) {
                    return data[0].season;
                }
                return null;
            } catch (error) {
                console.error("Erreur lors de la r√©cup√©ration de la saison actuelle:", error);
                return null;
            }
        }
        
        async function fetchAvailableEpisodes() {
            const wrapper = document.getElementById('episode-content-wrapper');
            const apiUrl = `${SUPABASE_URL}/rest/v1/${EPISODE_CONFIG_TABLE}?select=episode&season=eq.${CURRENT_SEASON}&order=episode.asc`;
            try {
                const response = await fetch(apiUrl, { 
                    method: 'GET', 
                    headers: { 'apikey': SUPABASE_ANON_KEY, 'Content-Type': 'application/json' } 
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`√âchec R√âCUP√âRATION EPISODES (${response.status}): ${errorText.substring(0, 100)}...`);
                }
                const data = await response.json();
                AVAILABLE_EPISODES = data.map(item => item.episode);
                return AVAILABLE_EPISODES.length > 0;
            } catch (error) {
                renderError(wrapper, "R√©cup√©ration des √âpisodes", error, currentLang);
                return false;
            }
        }

        function loadEpisodeSelector(initialEpisode) {
            const selectorContainer = document.getElementById('episode-selector-container');
            let html = `<label for="episode-select" data-i18n="select_episode_label">${translations[currentLang].select_episode_label}</label> 
                <select id="episode-select" onchange="changeEpisode(this.value)">`;
            AVAILABLE_EPISODES.forEach(ep => {
                const selected = (ep == initialEpisode) ? 'selected' : '';
                html += `<option value="${ep}" ${selected}>${translations[currentLang].episode_text} ${ep}</option>`;
            });
            html += '</select>';
            selectorContainer.innerHTML = html;
            document.getElementById('current-episode-display').textContent = initialEpisode;
            document.getElementById('current-season-display').textContent = CURRENT_SEASON;
            changeLanguage(currentLang);
        }

        function changeEpisode(episode) {
            CURRENT_EPISODE = parseInt(episode);
            document.getElementById('current-episode-display').textContent = CURRENT_EPISODE;
            loadEpisodeLeaderboard(CURRENT_EPISODE, currentLang);
        }

        async function loadEpisodeLeaderboard(episode, lang) {
            const wrapper = document.getElementById('episode-content-wrapper');
            wrapper.innerHTML = `<p style="padding: 50px;"><i class="fa-solid fa-spinner fa-spin-pulse fa-2x"></i> <span data-i18n="loading_data">${translations[lang].loading_data}</span></p>`;

            try {
                // 1. R√©cup√©rer les couleurs des √©quipes
                const teamDataMap = await fetchAllTeamData();

                // 2. CLASSEMENT √âPISODE (Vue: episode_leaderboard)
                // MODIFICATION : points_from_races est toujours s√©lectionn√© mais non affich√©
                const teamLeaderboardUrl = `${SUPABASE_URL}/rest/v1/${EPISODE_LEADERBOARD_VIEW}?select=team_id,team_name,${TEAM_POINTS_COLUMN},points_from_races,points_rafiki_episode&season=eq.${CURRENT_SEASON}&episode=eq.${episode}&order=${TEAM_POINTS_COLUMN}.desc`;
                const teamResponse = await fetch(teamLeaderboardUrl, {
                    method: 'GET',
                    headers: { 'apikey': SUPABASE_ANON_KEY, 'Content-Type': 'application/json' }
                });

                if (!teamResponse.ok) {
                    const errorText = await teamResponse.text();
                    throw new Error(`√âchec CLASSEMENT √âQUIPE (${teamResponse.status}): ${errorText.substring(0, 100)}...`);
                }
                const teamData = await teamResponse.json();
                
                // Message 'En cours' si pas de donn√©es
                if (teamData.length === 0) {
                    renderError(wrapper, "Classement √âpisode", new Error("Aucune donn√©e de classement trouv√©e."), lang, true);
                    return;
                }

                // 3. JOUEURS DE L'√âPISODE (Vue: player_episode_leaderboard)
                const playerLeaderboardUrl = `${SUPABASE_URL}/rest/v1/${PLAYER_EPISODE_LEADERBOARD_VIEW}?select=team_name,player_name,total_individual_points,${PLAYER_CONTRIBUTION_COLUMN}&season=eq.${CURRENT_SEASON}&episode=eq.${episode}&order=${PLAYER_CONTRIBUTION_COLUMN}.desc`;
                const playerResponse = await fetch(playerLeaderboardUrl, {
                    method: 'GET',
                    headers: { 'apikey': SUPABASE_ANON_KEY, 'Content-Type': 'application/json' }
                });

                if (!playerResponse.ok) {
                    const errorText = await playerResponse.text();
                    throw new Error(`√âchec CLASSEMENT JOUEURS (${playerResponse.status}): ${errorText.substring(0, 100)}...`);
                }
                const playersData = await playerResponse.json();

                // 4. Regroupement des joueurs par √âquipe (team_name)
                const playersByTeam = playersData.reduce((acc, player) => {
                    const key = player.team_name;
                    if (!acc[key]) {
                        acc[key] = [];
                    }
                    acc[key].push(player);
                    return acc;
                }, {});

                // 5. Construction du tableau HTML
                let htmlTable = `
                    <table>
                        <thead>
                            <tr>
                                <th data-i18n="table_rank">#</th>
                                <th data-i18n="table_team">√âquipe</th>
                                <th data-i18n="table_points">${translations[lang].table_points}</th> 
                                <th data-i18n="table_points_rafiki">${translations[lang].table_points_rafiki}</th>
                                <th data-i18n="table_players">${translations[lang].table_players}</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                teamData.forEach((team, index) => {
                    const rank = index + 1;
                    const teamName = team.team_name || translations[lang].unknown_team;
                    const totalPoints = team[TEAM_POINTS_COLUMN] || 0;
                    const rafikiPoints = team.points_rafiki_episode || 0;
                    // const pointsFromRaces = team.points_from_races || 0; // Donn√©e non affich√©e
                    
                    // Application de la couleur de texte pour le contraste
                    const teamColor = teamDataMap[teamName] ? teamDataMap[teamName].couleur : '#333';
                    const displayColor = getReadableTextColor(teamColor);

                    // Logique pour l'affichage des points Rafiki
                    const rafikiCellContent = (rafikiPoints === 0) 
                        ? ''
                        : ((rafikiPoints > 0 ? '+' : '') + rafikiPoints);

                    const teamPlayers = playersByTeam[teamName] || [];
                    
                    let playersHtml = `<ul class="player-sp-list">`;
                    if (teamPlayers.length === 0) {
                        playersHtml += `<li>${translations[lang].no_player_score}</li>`;
                    } else {
                        teamPlayers.sort((a, b) => (b[PLAYER_CONTRIBUTION_COLUMN] - a[PLAYER_CONTRIBUTION_COLUMN]));

                        teamPlayers.forEach(player => {
                            // MODIFICATION: Changement du format d'affichage du joueur
                            playersHtml += `<li>
                                ${player.player_name || translations[lang].unknown_player} 
                                - <span class="player-score">${player[PLAYER_CONTRIBUTION_COLUMN]} ${translations[lang].table_points_season}</span>
                            </li>`;
                        });
                    }
                    playersHtml += `</ul>`;

                    htmlTable += `
                        <tr>
                            <td>${rank}</td>
                            <td class="team-name-cell"><strong style="color: ${displayColor};">${teamName}</strong></td>
                            <td class="points-cell">${totalPoints}</td>
                            <td class="points-cell rafiki-points">${rafikiCellContent}</td>
                            <td>${playersHtml}</td>
                        </tr>
                    `;
                });

                htmlTable += '</tbody></table>';
                wrapper.innerHTML = htmlTable;
                changeLanguage(lang);
            } catch (error) {
                renderError(wrapper, "Classement √âpisode", error, lang);
            }
        }

        // ========================================================
        // 4. LOGIQUE DE L'ONGLET 'CLASSEMENT SAISON' (MISE √Ä JOUR)
        // ========================================================

        async function loadSeasonLeaderboard(lang) {
            const wrapper = document.getElementById('content-season');
            wrapper.innerHTML = `<p style="padding: 50px;"><i class="fa-solid fa-spinner fa-spin-pulse fa-2x"></i> <span data-i18n="loading_data">${translations[lang].loading_data}</span></p>`;

            try {
                 // 1. R√©cup√©rer les couleurs et logos des √©quipes
                const teamDataMap = await fetchAllTeamData();
                
                // 2. Requ√™te pour le classement g√©n√©ral
                const seasonLeaderboardUrl = `${SUPABASE_URL}/rest/v1/${SEASON_LEADERBOARD_VIEW}?select=team_name,total_team_points&order=total_team_points.desc`;
                
                const response = await fetch(seasonLeaderboardUrl, {
                    method: 'GET',
                    headers: { 'apikey': SUPABASE_ANON_KEY, 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`√âchec CLASSEMENT SAISON (${response.status}): ${errorText.substring(0, 100)}...`);
                }

                const data = await response.json();

                // Message 'En cours' si pas de donn√©es
                if (data.length === 0) {
                    wrapper.innerHTML = `<div class="info-block"><h2>${translations[lang].season_soon_title}</h2><p>${translations[lang].season_soon_text}</p></div>`;
                    changeLanguage(lang);
                    return;
                }

                // --- GESTION DU PODIUM (TOP 3) ---
                
                const podiumData = [
                    { rank: 1, team: data[0] || null, cssClass: 'first', stepCssClass: 'first-step', rankTextKey: 'podium_rank_1' },
                    { rank: 2, team: data[1] || null, cssClass: 'second', stepCssClass: 'second', rankTextKey: 'podium_rank_2' },
                    { rank: 3, team: data[2] || null, cssClass: 'third', stepCssClass: 'third', rankTextKey: 'podium_rank_3' },
                ];
                
                const defaultLogo = (text) => `https://placehold.co/120x120/4CAF50/ffffff?text=${text}`;

                const getPodiumItemHtml = (podiumSpot) => {
                    const team = podiumSpot.team;
                    if (!team) return ''; // No team for this spot
                    
                    const teamName = team.team_name || translations[lang].unknown_team;
                    const teamPoints = team.total_team_points || 0;
                    const rankText = translations[lang][podiumSpot.rankTextKey]; // Texte traduit (1er, 2√®me, 3√®me)
                    
                    const teamData = teamDataMap[teamName] || {};
                    const teamColor = teamData.couleur || '#333'; 
                    const displayColor = getReadableTextColor(teamColor);
                    
                    const logoPath = teamData.logo_path; 
                    const isDefaultLogo = !logoPath || logoPath.trim() === '';
                    
                    const imageUrl = isDefaultLogo 
                        ? defaultLogo(podiumSpot.rankTextKey)
                        : `${SUPABASE_URL}/storage/v1/object/public/logos/${logoPath}`; 
                    
                    return `
                        <div class="podium-item ${podiumSpot.cssClass}">
                            <span class="podium-rank-label" style="color: ${displayColor};">${rankText}</span>
                            <img src="${imageUrl}" alt="${teamName}" class="podium-team-image">
                            <p class="podium-team-name" style="color: ${displayColor};">${teamName}</p>
                            <p class="podium-points">${teamPoints} ${translations[lang].table_points_season}</p>
                        </div>
                    `;
                };

                const getPodiumStepHtml = (podiumSpot) => {
                    if (!podiumSpot.team) return ''; // No step if no team
                    
                    return `
                        <div class="podium-step ${podiumSpot.stepCssClass}">
                            <span class="rank-number">${podiumSpot.rank}</span>
                        </div>
                    `;
                };

                const podiumItemsHtml = podiumData.map(getPodiumItemHtml).join('');
                const podiumStepsHtml = podiumData.map(getPodiumStepHtml).join('');

                const podiumHtml = `
                    <h2 class="leader-title" style="font-size: 1.5em; margin-bottom: 20px;" data-i18n="season_leader_title">${translations[lang].season_leader_title}</h2>
                    <div id="season-podium-container">
                        <div id="podium-items-wrapper">
                            ${podiumItemsHtml}
                        </div>
                        <div class="podium-steps-structure">
                            ${podiumStepsHtml}
                        </div>
                    </div>
                `;
                
                // --- GESTION DU TABLEAU (√Ä PARTIR DU RANG 4) ---
                const tableData = data.slice(3); 

                let htmlTable = '';
                if (tableData.length > 0 || data.length <= 3) {
                     htmlTable = `
                        <table>
                            <thead>
                                <tr>
                                    <th data-i18n="table_rank">#</th>
                                    <th data-i18n="table_team">√âquipe</th>
                                    <th data-i18n="table_points_season">${translations[lang].table_points_season}</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    const teamsForTable = (data.length <= 3) ? data : tableData;
                    
                    teamsForTable.forEach((team, index) => {
                        const rank = (data.length <= 3) ? index + 1 : index + 4; 
                        
                        const teamName = team.team_name || translations[lang].unknown_team; 
                        const totalTeamPoints = team.total_team_points || 0;
                        
                        const teamColor = teamDataMap[teamName] ? teamDataMap[teamName].couleur : '#333';
                        const displayColor = getReadableTextColor(teamColor);

                        htmlTable += `
                            <tr>
                                <td>${rank}</td>
                                <td><strong style="color: ${displayColor};">${teamName}</strong></td>
                                <td class="points-cell">${totalTeamPoints}</td>
                            </tr>
                        `;
                    });

                    htmlTable += '</tbody></table>';
                }

                // Injection du Podium PUIS du tableau
                wrapper.innerHTML = podiumHtml + htmlTable;
                changeLanguage(lang); 
            } catch (error) {
                renderError(wrapper, "Classement Saison", error, lang);
            }
        }


        // ========================================================
        // 2. LOGIQUE DE L'ONGLET 'LISTE DES √âQUIPES'
        // ========================================================
        
        let teamsDataLoaded = false;
        async function loadTeamsData(lang) {
            const teamsContent = document.getElementById('content-teams');
            
            if (teamsDataLoaded && currentLang === lang) {
                changeLanguage(lang);
                return;
            }
            
            teamsContent.innerHTML = `<p style="padding: 50px;"><i class="fa-solid fa-spinner fa-spin-pulse fa-2x"></i> <span data-i18n="loading_data">${translations[lang].loading_data}</span></p>`;
            
            try {
                // 1. R√©cup√©rer toutes les √©quipes avec couleur/logo (utilise la fonction corrig√©e)
                const teamDataMap = await fetchAllTeamData();
                const teamsList = Object.values(teamDataMap).map(data => ({
                    id: data.id,
                    name: Object.keys(teamDataMap).find(key => teamDataMap[key].id === data.id), // R√©cup√©rer le nom
                    couleur: data.couleur
                }));

                // 2. R√©cup√©rer les points du classement saisonnier
                const leaderboardUrl = `${SUPABASE_URL}/rest/v1/${SEASON_LEADERBOARD_VIEW}?select=team_id,total_team_points&order=total_team_points.desc`;
                const leaderboardResponse = await fetch(leaderboardUrl, { 
                    method: 'GET', 
                    headers: { 'apikey': SUPABASE_ANON_KEY, 'Content-Type': 'application/json' } 
                });

                if (!leaderboardResponse.ok) {
                    throw new Error(`Erreur Supabase (Leaderboard): ${leaderboardResponse.status} ${leaderboardResponse.statusText}`);
                }
                const leaderboardData = await leaderboardResponse.json();

                // 3. Fusionner les donn√©es
                const pointsMap = leaderboardData.reduce((acc, item) => {
                    acc[item.team_id] = item.total_team_points || 0;
                    return acc;
                }, {});
                
                // Ajouter les points et trier (n√©cessaire pour le classement #)
                let finalRankedList = teamsList.map(team => ({
                    ...team,
                    total_team_points: pointsMap[team.id] || 0
                })).sort((a, b) => b.total_team_points - a.total_team_points);


                let htmlTable = `
                    <p style="text-align: left; margin-bottom: 10px;" data-i18n="teams_instruction">${translations[lang].teams_instruction}</p>
                    <table>
                        <thead>
                            <tr>
                                <th data-i18n="table_rank">#</th>
                                <th data-i18n="table_team">√âquipe</th>
                                <th data-i18n="table_members">Membres</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                finalRankedList.forEach((team, index) => {
                    const teamId = team.id; 
                    const teamName = team.name ? team.name.replace(/'/g, "\\'") : 'Nom Inconnu';
                    // const totalPoints = team.total_team_points || 0; // Donn√©e non affich√©e
                    
                    const teamColor = team.couleur || '#333'; 
                    const displayColor = getReadableTextColor(teamColor); 
                    
                    htmlTable += `
                        <tr id="team-row-${teamId}">
                            <td>${index + 1}</td>
                            <td><strong style="color: ${displayColor};">${team.name || 'Nom Inconnu'}</strong></td>
                            <td>
                                <button class="detail-button" onclick="showTeamDetails('${teamId}', '${teamName}', '${lang}', this)" data-i18n="button_details">${translations[lang].button_details}</button>
                                <div id="members-${teamId}" class="team-members-list" style="display: none;"></div>
                            </td>
                        </tr>
                    `;
                });
                
                htmlTable += '</tbody></table>';
                teamsContent.innerHTML = htmlTable;
                teamsDataLoaded = true;
                changeLanguage(lang);

            } catch (error) {
                renderError(teamsContent, "Liste des √âquipes", error, lang);
            }
        }

        async function showTeamDetails(teamId, teamName, lang, button) {
            const membersListDiv = document.getElementById(`members-${teamId}`);
            
            if (membersListDiv.style.display === 'block') {
                membersListDiv.style.display = 'none';
                button.textContent = translations[lang].button_details;
                return;
            }

            membersListDiv.style.display = 'block';
            button.textContent = translations[lang].button_hide;
            
            if (membersListDiv.innerHTML.trim() !== '') {
                changeLanguage(lang); 
                return;
            }

            membersListDiv.innerHTML = `<p style="text-align: center; margin-top: 10px;"><i class="fa-solid fa-spinner fa-spin-pulse"></i> ${translations[lang].loading_members}</p>`;

            const apiUrl = `${SUPABASE_URL}/rest/v1/${MEMBERS_TABLE}?select=player_id,players(name),is_referent&team_id=eq.${teamId}&is_active=eq.true&is_temp=eq.false&order=is_referent.desc`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: { 'apikey': SUPABASE_ANON_KEY, 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    throw new Error(`Erreur Supabase: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                
                let membersHtml = `<strong>${translations[lang].members_title} ${teamName.replace(/\\'/g, "'")} :</strong> <ul>`;

                if (data.length === 0) {
                    membersHtml = `<p>${translations[lang].no_members_found}</p>`;
                } else {
                    data.forEach(member => {
                        const playerName = member.players?.name || translations[lang].unknown_player;
                        const role = member.is_referent ? ` (${translations[lang].captain_text})` : '';
                        membersHtml += `<li>${playerName}${role}</li>`;
                    });
                    membersHtml += '</ul>';
                }
                
                membersListDiv.innerHTML = membersHtml;
            } catch (error) {
                console.error(`Erreur lors de la r√©cup√©ration des membres pour l'√©quipe ${teamId}:`, error);
                membersListDiv.innerHTML = `<p style="color: red;">${translations[lang].members_error}: ${error.message}</p>`;
            }
        }

        // ========================================================
        // 3. LOGIQUE DE TRADUCTION ET DE NAVIGATION
        // ========================================================
        
        const translations = {
            fr: {
                results_page_title: "Graou Challenge | R√©sultats",
                logo: "Graou Challenge",
                nav_home: "Accueil",
                nav_about: "L'√©v√©nement",
                nav_results: "R√©sultats",
                nav_rules: "R√®glement",
                nav_register: "Inscription",
                results_main_title_dynamic: "Tableau de bord des R√©sultats",
                tab_teams: "Liste des √âquipes",
                tab_episode: "Leaderboard √âpisode",
                tab_season: "Classement Saison",
                loading_data: "Chargement des donn√©es...",
                loading_members: "Chargement des membres...",
                error_title: "Erreur de chargement",
                error_text: "Impossible de r√©cup√©rer les donn√©es depuis Supabase.",
                unknown_player: "Joueur Inconnu",
                unknown_team: "√âquipe Inconnue",
                no_members_found: "Aucun membre permanent trouv√© pour cette √©quipe.",
                members_title: "Membres de l'√©quipe",
                members_error: "Erreur lors de la r√©cup√©ration des membres",
                button_details: "D√©tails",
                button_hide: "Masquer",
                select_episode_label: "S√©lectionnez l'√âpisode :",
                episode_leaderboard_title_label: "R√©sultats √âpisode",
                season_text: "Saison",
                episode_text: "√âpisode",
                captain_text: "Capitaine",
                table_rank: "#",
                table_team: "√âquipe",
                table_members: "Membres",
                // MODIFICATION: Renommage Pts √âpisode en Points
                table_points: "Points", 
                table_points_rafiki: "Pts Rafiki",
                table_points_races: "Pts Courses", 
                table_points_season: "Points", 
                // MODIFICATION: Renommage Joueurs (Pts) en Joueurs
                table_players: "Joueurs", 
                table_players_pts: "Joueurs (Pts)", // Gard√© pour l'ancienne logique au cas o√π
                no_player_score: "Pas de score individuel enregistr√©.",
                episode_in_progress: "√âpisode en cours",
                episode_in_progress_detail: "Les r√©sultats de cet √©pisode ne sont pas encore agr√©g√©s ou l'√©pisode est en cours de diffusion. Revenez apr√®s la fin de la course.",
                teams_instruction: "Cliquez sur 'D√©tails' pour voir les membres permanents actifs.",
                season_leader_title: "Podium du Classement G√©n√©ral", 
                season_soon_title: "Classement Saison",
                season_soon_text: "Le classement est en cours de compilation ou la saison n'a pas encore commenc√©.",
                episode_soon_title: "Classement √âpisode", 
                episode_soon_text: "Les donn√©es d'√©pisode ne sont pas encore disponibles ou la saison n'a pas commenc√©.", 
                // NOUVELLES TRADUCTIONS POUR LE PODIUM
                podium_rank_1: "1er", 
                podium_rank_2: "2√®me",
                podium_rank_3: "3√®me",
                footer_twitch_text: "Twitch",
                footer_discord_text: "Discord",
                footer_youtube_text: "YouTube",
                footer_tiktok_text: "TikTok",
                footer_instagram_text: "Instagram",
                footer_donation_text: "Donation",
                footer_rights: "¬© 2025 Graou Challenge. Tous droits r√©serv√©s."
            },
            en: {
                results_page_title: "Graou Challenge | Results",
                logo: "Graou Challenge",
                nav_home: "Home",
                nav_about: "The Event",
                nav_results: "Results",
                nav_rules: "Rules",
                nav_register: "Register",
                results_main_title_dynamic: "Results Dashboard",
                tab_teams: "Team List",
                tab_episode: "Episode Leaderboard",
                tab_season: "Season Ranking",
                loading_data: "Loading data...",
                loading_members: "Loading members...",
                error_title: "Loading Error",
                error_text: "Could not retrieve data from Supabase.",
                unknown_player: "Unknown Player",
                unknown_team: "Unknown Team",
                no_members_found: "No permanent active members found for this team.",
                members_title: "Team Members for",
                members_error: "Error retrieving members",
                button_details: "Details",
                button_hide: "Hide",
                select_episode_label: "Select Episode:",
                episode_leaderboard_title_label: "Episode Results",
                season_text: "Season",
                episode_text: "Episode",
                captain_text: "Captain",
                table_rank: "#",
                table_team: "Team",
                table_members: "Members",
                // MODIFICATION: Renommage Pts √âpisode en Points
                table_points: "Points",
                table_points_rafiki: "Rafiki Pts",
                table_points_races: "Race Pts",
                table_points_season: "Points",
                // MODIFICATION: Renommage Joueurs (Pts) en Joueurs
                table_players: "Players",
                table_players_pts: "Players (Pts)", // Gard√© pour l'ancienne logique au cas o√π
                no_player_score: "No individual score recorded.",
                episode_in_progress: "Episode In Progress",
                episode_in_progress_detail: "The results for the selected episode are not yet aggregated or the episode is currently running. Check back after the race ends.",
                teams_instruction: "Click 'Details' to see active permanent members.",
                season_leader_title: "Overall Ranking Podium", 
                season_soon_title: "Season Ranking",
                season_soon_text: "The ranking is being compiled or the season has not started yet.",
                episode_soon_title: "Episode Ranking", 
                episode_soon_text: "Episode data is not yet available or the season has not started.", 
                // NOUVELLES TRADUCTIONS POUR LE PODIUM
                podium_rank_1: "1st", 
                podium_rank_2: "2nd",
                podium_rank_3: "3rd",
                footer_twitch_text: "Twitch",
                footer_discord_text: "Discord",
                footer_youtube_text: "YouTube",
                footer_tiktok_text: "TikTok",
                footer_instagram_text: "Instagram",
                footer_donation_text: "Donation",
                footer_rights: "¬© 2025 Graou Challenge. All rights reserved."
            },
            de: {
                results_page_title: "Graou Challenge | Ergebnisse",
                logo: "Graou Challenge",
                nav_home: "Startseite",
                nav_about: "Das Event",
                nav_results: "Ergebnisse",
                nav_rules: "Regeln",
                nav_register: "Anmeldung",
                results_main_title_dynamic: "Ergebnis-Dashboard",
                tab_teams: "Teamliste",
                tab_episode: "Episode Rangliste",
                tab_season: "Saison Rangliste",
                loading_data: "Daten werden geladen...",
                loading_members: "Mitglieder werden geladen...",
                error_title: "Fehler beim Laden",
                error_text: "Daten konnten nicht von Supabase abgerufen werden.",
                unknown_player: "Unbekannter Spieler",
                unknown_team: "Unbekanntes Team",
                no_members_found: "Keine aktiven st√§ndigen Mitglieder f√ºr dieses Team gefunden.",
                members_title: "Teammitglieder f√ºr",
                members_error: "Fehler beim Abrufen der Mitglieder",
                button_details: "Details",
                button_hide: "Verbergen",
                select_episode_label: "W√§hlen Sie die Episode:",
                episode_leaderboard_title_label: "Episode Ergebnisse",
                season_text: "Saison",
                episode_text: "Episode",
                captain_text: "Kapit√§n",
                table_rank: "#",
                table_team: "Team",
                table_members: "Mitglieder",
                // MODIFICATION: Renommage Pts √âpisode en Points
                table_points: "Punkte",
                table_points_rafiki: "Rafiki Pkte",
                table_points_races: "Rennen Pkte",
                table_points_season: "Punkte",
                // MODIFICATION: Renommage Joueurs (Pts) en Joueurs
                table_players: "Spieler",
                table_players_pts: "Spieler (Pkte)", // Gard√© pour l'ancienne logique au cas o√π
                no_player_score: "Keine individuellen Punkte erfasst.",
                episode_in_progress: "Episode l√§uft",
                episode_in_progress_detail: "Die Ergebnisse der ausgew√§hlten Episode sind noch nicht aggregiert oder die Episode l√§uft gerade. Schauen Sie nach dem Ende des Rennens noch einmal vorbei.",
                teams_instruction: "Klicken Sie auf 'Details', um aktive st√§ndige Mitglieder anzuzeigen.",
                season_leader_title: "Gesamtwertung Podium", 
                season_soon_title: "Saison Rangliste",
                season_soon_text: "Das Ranking wird gerade erstellt oder die Saison hat noch nicht begonnen.",
                episode_soon_title: "Episode Rangliste", 
                episode_soon_text: "Episode data is not yet available or the season has not started.", 
                // NOUVELLES TRADUCTIONS POUR LE PODIUM
                podium_rank_1: "1.", 
                podium_rank_2: "2.",
                podium_rank_3: "3.",
                footer_twitch_text: "Twitch",
                footer_discord_text: "Discord",
                footer_youtube_text: "YouTube",
                footer_tiktok_text: "TikTok",
                footer_instagram_text: "Instagram",
                footer_donation_text: "Spende",
                footer_rights: "¬© 2025 Graou Challenge. Alle Rechte vorbehalten."
            }
        };

        function changeLanguage(lang) {
            currentLang = lang;
            document.documentElement.lang = lang; 

            // 1. Mettre √† jour les attributs data-i18n
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                // MODIFICATION: Mettre √† jour les cl√©s de traduction pour l'onglet √âpisode
                const newKey = {
                    'table_points_episode': 'table_points',
                    'table_players_pts': 'table_players'
                }[key] || key;
                
                if (translations[lang] && translations[lang][newKey]) {
                    if (element.tagName === 'TITLE' || element.tagName === 'H1') {
                        element.textContent = translations[lang][newKey];
                    } else if (element.tagName === 'INPUT' && element.type === 'submit') {
                        element.value = translations[lang][newKey];
                    } else {
                        element.textContent = translations[lang][newKey];
                    }
                }
            });
            
            // 2. Mettre √† jour l'affichage dynamique (saison/√©pisode)
            const episodeDisplay = document.getElementById('current-episode-display');
            if (episodeDisplay) {
                episodeDisplay.textContent = CURRENT_EPISODE || '...';
            }
            const seasonDisplay = document.getElementById('current-season-display');
            if (seasonDisplay) {
                seasonDisplay.textContent = CURRENT_SEASON || '...';
            }

            // 3. Mettre √† jour le s√©lecteur d'√©pisodes et les boutons
            const episodeSelect = document.getElementById('episode-select');
            if (episodeSelect) {
                const label = document.querySelector('label[for="episode-select"]');
                if(label) label.textContent = translations[lang].select_episode_label;
                
                AVAILABLE_EPISODES.forEach(ep => {
                    const option = episodeSelect.querySelector(`option[value="${ep}"]`);
                    if (option) {
                        option.textContent = `${translations[lang].episode_text} ${ep}`;
                    }
                });
            }

            // 4. Mise √† jour des boutons d√©tails/masquer
            document.querySelectorAll('.detail-button').forEach(button => {
                const membersDiv = button.nextElementSibling;
                const isHidden = !membersDiv || membersDiv.style.display === 'none' || membersDiv.style.display === '';
                button.textContent = isHidden ? translations[lang].button_details : translations[lang].button_hide;
            });
        }

        function switchTab(tabId) {
            // 1. G√©rer les classes d'onglets (buttons et content)
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active-content');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            document.getElementById(`content-${tabId}`).classList.add('active-content');
            document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');

            // 2. D√©clencher le chargement des donn√©es si n√©cessaire
            const lang = currentLang || 'fr';
            const contentDiv = document.getElementById(`content-${tabId}`);
            
            // Check si le contenu a d√©j√† √©t√© g√©n√©r√© (table ou message d'info)
            const hasContent = contentDiv.querySelector('table') || contentDiv.querySelector('.info-block') || contentDiv.querySelector('#season-podium-container');

            if (tabId === 'teams') {
                loadTeamsData(lang); 
            } else if (tabId === 'season') {
                // Charger la saison uniquement si l'onglet est vide (premi√®re s√©lection)
                if (!hasContent) {
                    loadSeasonLeaderboard(lang);
                } else {
                    // Si le contenu existe, on le met juste √† jour pour la traduction
                    changeLanguage(lang);
                }
            } else if (tabId === 'episode') {
                const episodeWrapper = document.getElementById('episode-content-wrapper');
                // On v√©rifie le contenu de l'√©pisode wrapper
                const hasEpisodeContent = episodeWrapper.querySelector('table') || episodeWrapper.querySelector('.info-block');
                
                // Si pas de contenu, mais qu'on a les infos d'√©pisode, on force le chargement.
                // Normalement pr√©-charg√© dans DOMContentLoaded, cette logique est un filet de s√©curit√©.
                if (!hasEpisodeContent && CURRENT_SEASON && AVAILABLE_EPISODES.length > 0) {
                    loadEpisodeLeaderboard(CURRENT_EPISODE, lang);
                } else {
                     // Si le contenu existe, on le met juste √† jour pour la traduction
                    changeLanguage(lang);
                }
            }
            
            changeLanguage(lang);
        }

        // ========================================================
        // 5. CHARGEMENT INITIAL 
        // ========================================================
        
        document.addEventListener('DOMContentLoaded', async () => {
            const initialLang = getInitialLanguage();
            currentLang = initialLang;

            // 1. Pr√©-chargement des donn√©es de saison/√©pisode (pour l'onglet Episode)
            CURRENT_SEASON = await fetchCurrentSeason(); 
            if (CURRENT_SEASON) {
                const success = await fetchAvailableEpisodes(); 
                if (success) {
                    CURRENT_EPISODE = AVAILABLE_EPISODES[AVAILABLE_EPISODES.length - 1]; 
                    loadEpisodeSelector(CURRENT_EPISODE);
                    
                    // Chargement du leaderboard de l'√©pisode par d√©faut (le dernier)
                    loadEpisodeLeaderboard(CURRENT_EPISODE, initialLang);
                } else {
                    // Afficher un message si aucune donn√©e d'√©pisode n'est trouv√©e pour la saison
                    const wrapper = document.getElementById('episode-content-wrapper');
                    wrapper.innerHTML = `<div class="info-block"><h2>${translations[initialLang].episode_soon_title}</h2><p>${translations[initialLang].episode_soon_text}</p></div>`;
                }
            } else {
                 // Afficher un message si aucune saison n'a pu √™tre trouv√©e
                 const wrapper = document.getElementById('episode-content-wrapper');
                 wrapper.innerHTML = `<div class="info-block"><h2>${translations[initialLang].episode_soon_title}</h2><p>${translations[initialLang].episode_soon_text}</p></div>`;
            }
            
            // 2. Charger et afficher la Liste des √âquipes (COMPORTEMENT PAR D√âFAUT)
            await loadTeamsData(initialLang);
            
            // 3. S'assurer que les classes active sont bien positionn√©es sur 'teams'
            switchTab('teams'); 
            
            changeLanguage(initialLang);
        });
    </script>
</body>
</html>